---
import { getCollection, getEntry, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');

  // Exclude the initial example post from the built site.
  return posts.filter((post) => post.id !== 'hello-world').map((post) => ({
    params: { slug: post.id },
    props: { id: post.id },
  }));
}

const { id } = Astro.props;

const entry = await getEntry('blog', id);
if (!entry) {
  throw new Error(`Could not find blog post: ${id}`);
}

// SEO: Provide canonical + social metadata using the configured `site` URL.
const canonicalURL = new URL(Astro.url.pathname, Astro.site ?? Astro.url);
const socialImagePath = entry.data.hero_image ?? '/images/atwine_headshot.jpg';
const socialImageURL = new URL(socialImagePath, Astro.site ?? Astro.url);

// SEO: Minimal structured data to help search engines understand the page is an Article.
const articleJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: entry.data.title,
  description: entry.data.description,
  datePublished: entry.data.date.toISOString(),
  mainEntityOfPage: canonicalURL.toString(),
  author: {
    '@type': 'Person',
    name: 'Mugume Twinamatsiko Atwine',
    url: 'https://atwine.github.io/',
  },
  image: [socialImageURL.toString()],
};

const { Content } = await render(entry);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{entry.data.title} - Mugume Twinamatsiko Atwine</title>
    <meta name="description" content={entry.data.description} />
    <!-- SEO: Canonical + social previews -->
    <link rel="canonical" href={canonicalURL} />
    <meta property="og:type" content="article" />
    <meta property="og:title" content={entry.data.title} />
    <meta property="og:description" content={entry.data.description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={socialImageURL} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={entry.data.title} />
    <meta name="twitter:description" content={entry.data.description} />
    <meta name="twitter:image" content={socialImageURL} />
    <script type="application/ld+json">{JSON.stringify(articleJsonLd)}</script>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/blog.css" />
  </head>
  <body class="blog">
    <div class="container">
      <nav class="navbar">
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/blog/">Articles</a></li>
        </ul>
      </nav>

      <main>
        <section>
          <h1>{entry.data.title}</h1>
          <p class="blog-meta">{entry.data.date.toISOString().slice(0, 10)}</p>
          <div class="blog-content">
            <Content />
          </div>
        </section>
      </main>
    </div>

    <div id="blogImageModal" class="blog-image-modal" hidden>
      <div class="blog-image-modal__backdrop" data-close></div>
      <div class="blog-image-modal__content" role="dialog" aria-modal="true" aria-label="Image preview">
        <button type="button" class="blog-image-modal__close" data-close>Close</button>
        <img id="blogImageModalImg" alt="" />
      </div>
    </div>

    <script>
      // Blog-only click-to-zoom for Markdown images. (Avoids loading homepage-only main.js.)
      const modal = document.getElementById('blogImageModal');
      const modalImg = document.getElementById('blogImageModalImg');

      function openImageModal(imgEl) {
        if (!modal || !modalImg) return;
        modalImg.src = imgEl.currentSrc || imgEl.src;
        modalImg.alt = imgEl.alt || '';
        modal.hidden = false;
        document.body.classList.add('blog-image-modal-open');
      }

      function closeImageModal() {
        if (!modal || !modalImg) return;
        modal.hidden = true;
        modalImg.src = '';
        modalImg.alt = '';
        document.body.classList.remove('blog-image-modal-open');
      }

      document.querySelectorAll('.blog-content img').forEach((imgEl) => {
        imgEl.addEventListener('click', () => openImageModal(imgEl));
      });

      modal?.querySelectorAll('[data-close]')?.forEach((el) => {
        el.addEventListener('click', closeImageModal);
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeImageModal();
      });
    </script>
    <!-- main.js is homepage-only (scroll popup); avoid errors on blog pages where those DOM IDs don't exist. -->
  </body>
</html>
